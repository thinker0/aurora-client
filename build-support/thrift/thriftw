#!/usr/bin/env bash
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
#
# Wrapper for thrift that attempts to use the system thrift if it's of the expected version,
# otherwise it bootstraps a new one.
set -ex -u

if [[ $# -lt 1 ]]; then
  cat <<EOF
Usage: thriftw EXPECTED_THRIFT_VERSION THRIFT_ARGS...

Run the thrift compiler at EXPECTED_THRIFT_VERSION with THRIFT_ARGS, bootstrapping if necessary.
EOF
fi
expected_version=$1
shift

HERE=$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)

function check_thrift_version() {
  local readonly thrift="$1"

  [[ $("${thrift}" --version) = "Thrift version ${expected_version}" ]]
}

function check_thrift_gen_lang() {
  local readonly thrift="$1"
  local readonly gen_identifier="$2"

  "${thrift}" -help 2>&1 | grep -q "${gen_identifier}:"
}

function compatible_thrift() {
  local readonly thrift="$1"

  [[ -x "${thrift}" ]] && \
  check_thrift_version "${thrift}" && \
  check_thrift_gen_lang "${thrift}" "java (Java)" && \
  check_thrift_gen_lang "${thrift}" "js (Javascript)" && \
  check_thrift_gen_lang "${thrift}" "html (HTML)" && \
  check_thrift_gen_lang "${thrift}" "py (Python)"
}

function compatible_system_thrift() {
  if compatible_thrift "${HERE}/thrift"; then
    echo "${HERE}/thrift"
  else
    which -a thrift 2> /dev/null | while read thrift; do
      if compatible_thrift "${thrift}"; then
         echo "${thrift}"
         return
      fi
    done
  fi
}

function nproc_count() {
  if command -v nproc &> /dev/null; then
    nproc
  elif command -v getconf &> /dev/null; then
    getconf _NPROCESSORS_ONLN
  else
    echo 1
  fi
}

function build_thrift_from_source() {
  local readonly version="$1"
  local readonly build_root="${HERE}/.thrift-build/${version}"
  local readonly install_root="${HERE}/.thrift-install/${version}"
  local readonly thrift_bin="${install_root}/bin/thrift"
  local readonly tarball="thrift-${version}.tar.gz"
  local readonly url="https://archive.apache.org/dist/thrift/${version}/${tarball}"

  if [[ -x "${thrift_bin}" ]]; then
    echo "${thrift_bin}"
    return
  fi

  mkdir -p "${build_root}" "${install_root}"
  if [[ ! -f "${build_root}/${tarball}" ]]; then
    wget -O "${build_root}/${tarball}" "${url}"
  fi

  rm -rf "${build_root}/thrift-${version}"
  tar --no-same-owner -xzf "${build_root}/${tarball}" -C "${build_root}"
  pushd "${build_root}/thrift-${version}" &> /dev/null
  ./configure --prefix="${install_root}" --disable-tests 1>&2
  make -j"$(nproc_count)" 1>&2
  make install 1>&2
  popd &> /dev/null

  if [[ -x "${thrift_bin}" ]]; then
    echo "${thrift_bin}"
  fi
}

thrift="$(compatible_system_thrift)"
if [[ -z "${thrift}" ]]; then
  thrift="$(build_thrift_from_source "${expected_version}")"

  if ! compatible_thrift "${thrift}"; then
    echo "Failed to find or build a thrift binary compatible with Aurora requirements!"
    exit 1
  fi

  rm -f "${HERE}/thrift"
  cp -f "${thrift}" "${HERE}/thrift"
  chmod +x "${HERE}/thrift"

  if [[ -w /usr/bin ]]; then
    cp -f "${thrift}" /usr/bin/thrift
    chmod +x /usr/bin/thrift
  fi
fi

exec "${thrift}" "$@"
